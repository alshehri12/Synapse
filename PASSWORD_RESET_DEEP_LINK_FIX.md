# Password Reset - Deep Link Solution (PKCE Compatible)

## Problem

The previous web-based password reset was failing with error:
```
Error: invalid request: both auth code and code verifier should be non-empty
```

**Root Cause**: Supabase uses PKCE (Proof Key for Code Exchange) flow for security. PKCE requires:
1. The app generates a `code_verifier` when requesting password reset
2. Supabase sends a `code` in the email link
3. To exchange the `code` for a session, you need BOTH the `code` AND the original `code_verifier`

**Why web page failed**: The web page only had the `code` from the URL, but didn't have the `code_verifier` (which was generated by the mobile app). This made PKCE code exchange impossible.

## Solution: Deep Link to App

Instead of resetting password on a web page, redirect users **back to the app** where PKCE can work properly.

### Flow:

1. **User taps "Forgot Password"** in app
2. **App requests reset** → Supabase sends email
3. **User clicks "Reset My Password"** in email
4. **Deep link opens app**: `synapse://reset-password?code=xxx`
5. **App exchanges code for session** (PKCE works because app has the verifier)
6. **App shows ResetPasswordView**
7. **User enters new password**
8. **Password updated** ✅

### Benefits:

- ✅ PKCE works properly (app has both code and verifier)
- ✅ Better UX (native app experience)
- ✅ No web hosting required
- ✅ More secure (PKCE is better than implicit flow)
- ✅ Works offline after initial link click

## Files Changed

### 1. SupabaseManager.swift

**Added methods:**
```swift
// Request password reset (sends email with deep link)
func resetPassword(email: String) async throws

// Handle deep link from email
func handlePasswordResetDeepLink(url: URL) async throws

// Update password after session established
func updatePassword(newPassword: String) async throws
```

**Key change in `resetPassword()`:**
```swift
// OLD: Web redirect (doesn't work with PKCE)
let redirectURL = URL(string: "https://usynapse.com/reset-password.html")!

// NEW: Deep link to app (PKCE compatible)
let redirectURL = URL(string: "synapse://reset-password")!
```

### 2. SynapseApp.swift

**Added:**
- Deep link handler with `.onOpenURL`
- State variable to show password reset sheet
- Password reset sheet presentation

**Deep link handler:**
```swift
.onOpenURL { url in
    handleDeepLink(url)
}

private func handleDeepLink(_ url: URL) {
    if url.host == "reset-password" {
        Task {
            try await supabaseManager.handlePasswordResetDeepLink(url: url)
            showPasswordReset = true
        }
    }
}
```

### 3. ResetPasswordView.swift (NEW)

**Created a beautiful native password reset screen with:**
- New password field
- Confirm password field
- Real-time password requirements validation
- Loading states
- Error handling
- Success animation
- Native iOS design

## Setup Instructions

### Step 1: Update Supabase Redirect URL

1. Go to **Supabase Dashboard**
2. Select your Synapse project
3. Navigate to: **Authentication → URL Configuration**
4. Under **Redirect URLs**, add:
   ```
   synapse://reset-password
   ```
5. **Save** and wait 2-3 minutes for propagation

### Step 2: Verify URL Scheme

The app should already have the URL scheme configured in Info.plist:
```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>synapse</string>
        </array>
    </dict>
</array>
```

### Step 3: Clean Build & Test

1. **Clean Build Folder**: `Cmd + Shift + K`
2. **Build**: `Cmd + B`
3. **Run** the app

### Step 4: Test the Flow

1. Open app on device/simulator
2. Tap "Forgot Password?"
3. Enter email address
4. Tap "Send Reset Link"
5. Check email (use a real device for best results)
6. Click "Reset My Password" in email
7. App should open and show password reset screen
8. Enter new password
9. Submit and verify success

## Technical Details

### PKCE Flow Explained:

**When requesting password reset:**
```swift
// App automatically generates code_verifier (stored internally by Supabase SDK)
try await supabaseClient.auth.resetPasswordForEmail(
    email,
    redirectTo: URL(string: "synapse://reset-password")!
)
```

**When handling deep link:**
```swift
// Extract code from URL: synapse://reset-password?code=abc123
let code = components.queryItems?.first(where: { $0.name == "code" })?.value

// Exchange code for session (SDK uses stored code_verifier)
try await supabaseClient.auth.exchangeCodeForSession(code: code)
// ✅ Session established!
```

**When updating password:**
```swift
// Now we have an active session, we can update password
try await supabaseClient.auth.update(user: UserAttributes(password: newPassword))
// ✅ Password updated!
```

### Why This Works:

1. The **Supabase SDK** stores the `code_verifier` internally when you call `resetPasswordForEmail()`
2. When the deep link opens the app, the **same app instance** still has access to that `code_verifier`
3. When you call `exchangeCodeForSession(code:)`, the SDK automatically uses the stored `code_verifier`
4. PKCE exchange succeeds! ✅

### Why Web Page Didn't Work:

1. App generates `code_verifier` and requests reset
2. User clicks email link → opens web browser (different process)
3. Web page only has `code` from URL
4. Web page has NO ACCESS to the `code_verifier` that was generated by the app
5. PKCE exchange fails ❌

## Troubleshooting

### Deep link doesn't open app:

**Check:**
- URL scheme is configured in Info.plist (`synapse://`)
- Supabase redirect URL is set to `synapse://reset-password`
- App is installed on device

**Test deep link manually:**
```bash
# On simulator:
xcrun simctl openurl booted "synapse://reset-password?code=test123"

# On device via Safari:
# Type in Safari: synapse://reset-password?code=test123
```

### "Invalid reset link: no code found":

**Check:**
- URL contains `?code=xxx` parameter
- Supabase email template is using `{{ .ConfirmationURL }}`

### "Failed to exchange code for session":

**Check:**
- Code hasn't expired (typically valid for 5-10 minutes)
- Code hasn't been used already (one-time use only)
- Network connection is available

### Password update fails:

**Check:**
- Session was established successfully
- Password meets requirements (6+ characters)
- User is authenticated

## Comparison: Web vs Deep Link

| Aspect | Web Page | Deep Link (Current) |
|--------|----------|---------------------|
| **PKCE Compatible** | ❌ No | ✅ Yes |
| **Security** | ⚠️ Implicit flow only | ✅ PKCE (most secure) |
| **User Experience** | Opens browser | Opens app directly |
| **Hosting Required** | Yes (usynapse.com) | No |
| **Offline Support** | No | Yes (after link click) |
| **Native Design** | No | Yes |
| **Maintenance** | Two codebases | One codebase |

## Email Template

Make sure your Supabase password reset email template uses:

```html
<a href="{{ .ConfirmationURL }}">Reset My Password</a>
```

This will automatically generate the URL with the correct format:
```
synapse://reset-password?code=abc123xyz...
```

## Security Notes

- **PKCE is more secure** than implicit flow (no tokens in URL)
- **Code can only be used once** (replay attack protection)
- **Code expires quickly** (typically 5-10 minutes)
- **Code is useless without verifier** (interception protection)

## Next Steps

1. ✅ Upload changes to repository
2. ✅ Update Supabase redirect URL
3. ✅ Test on real device
4. ✅ Deploy to TestFlight/App Store

---

**Created**: 2025-01-01
**Issue**: PKCE code verifier error on web-based password reset
**Solution**: Deep link to app for native password reset with PKCE support
