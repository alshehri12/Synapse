rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Public idea sparks - anyone can read, authenticated users can write
    match /ideaSparks/{ideaId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email_verified == true;
    }
    
    // Private idea sparks - only owner can access
    match /users/{userId}/privateIdeaSparks/{ideaId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Pods - members can read/write pod data
    match /pods/{podId} {
      allow read, write: if request.auth != null && request.auth.token.email_verified == true && 
        (request.auth.uid in resource.data.members || 
         request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      
      // Pod members subcollection
      match /members/{memberId} {
        allow read, write: if request.auth != null && 
          (request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      }
      
      // Online users subcollection
      match /onlineUsers/{userId} {
        allow read, write: if request.auth != null && 
          (request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      }
    }
    
    // Chat messages - only pod members can access
    match /chats/{podId} {
      // Allow read/write if user is a member of the pod
      allow read, write: if request.auth != null && 
        (request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      
      // Chat messages subcollection
      match /messages/{messageId} {
        allow read, write: if request.auth != null && 
          (request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      }
      
      // Typing indicators subcollection
      match /typing/{userId} {
        allow read, write: if request.auth != null && 
          (request.auth.uid in get(/databases/$(database)/documents/pods/$(podId)).data.members);
      }
    }
    
    // Notifications - users can read/write their own notifications
    match /notifications/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /userNotifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // General rule: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 